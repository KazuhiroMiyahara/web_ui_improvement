<!DOCTYPE html>
<html>
  <head>
    <title>WEB UI Test Page</title>
    <link rel="stylesheet" href="style.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  </head>

  <body>
    <h1>Spark Data Web Analyzer</h1>
    <h2>Executer Timeline</h2>
    <script type="text/javascript">
var dataQuantity = 50;
var executorTimeArray = [];
var minTaskCountPerExecutor = 5;
var maxTaskCountPerExecutor = 10;

for(var i = 0; i < dataQuantity; i++){
  var executorTime = {
    id: i,
    ExecutorID: i,
    Tasks: []
  }

  taskCount = minTaskCountPerExecutor + Math.floor(Math.random() * (maxTaskCountPerExecutor - minTaskCountPerExecutor));
  tmpTime = 0.0;

  for(var j=0; j < taskCount; j++){
    taskTimeMinimum = {
      ID: j,
      TaskID: Math.floor(Math.random() * 1000),
      start: tmpTime = tmpTime + Math.random() * (j % 5 == 0 && j != 0 ? 1000 : 10),
      end: tmpTime = tmpTime + Math.random() * 1000
    }

    executorTime.Tasks.push(taskTimeMinimum);
  }

  executorTimeArray.push(executorTime);
}

var barGraphWidth = 24;
var spacePerData = 32;
var margin = 0;
var IDSpace = 100;
var graphRightPadding = 100;

var graphSvgHeight = dataQuantity * spacePerData;
var graphSvgWidth = 1600;
var graphDivHeight = 500;
var graphDivWidth = graphSvgWidth;

var graphDivTop = 120;
var graphDivLeft = 0;

var graphDiv = d3
.select("body")
.append("div")
.style("height", graphDivHeight + "px")
.style("width", graphDivWidth + "px")
.style("overflow-x", "hidden")
.style("overflow-y", "scroll")
.style("position", "absolute")
.style("top", graphDivTop + "px")
.style("left", graphDivLeft + "px");

var graphSvg = graphDiv
.append("svg")
.attr("width", graphSvgWidth)
.attr("height", graphSvgHeight);

var maxLength = d3.max(executorTimeArray, function(d) { return d.Tasks[d.Tasks.length - 1].end; });
var xScale = d3.scale.linear().domain([0, maxLength]).range([0, graphSvgWidth - graphRightPadding - IDSpace]);

var xAxis = d3.svg.axis().scale(xScale).orient("bottom");

var group = graphSvg
.selectAll("g")
.data(executorTimeArray)
.enter()
.append("g")
.attr("transform", function(d,i) { return "translate(0," + i * spacePerData + ")"; });

group
.append("rect")
.style("fill", function(d,i) {
  return i % 2 == 0 ? "rgb(200,200,200)" : "rgb(225,225,225)";
})
.attr("x", 0)
.attr("y", 0)
.attr("width", function(d) {
  return IDSpace + xScale(maxLength) + graphRightPadding;
})
.attr("height", spacePerData);

var xAxisTick = d3.svg.axis().scale(xScale).orient("bottom").tickSize(graphSvgHeight).tickSubdivide(true);

graphSvg.append("g")
.attr("class", "axis")
.attr("transform", "translate(" + IDSpace + ",0)")
.call(xAxisTick);

var executorIdFontSize = 16;

group
.append("text")
.text(function(d) {
  return "ExecutorID: " + d.ExecutorID;
})
.attr("font-size", executorIdFontSize + "px")
.attr("fill", "black")
.attr("x", 0)
.attr("y", function(d) {
  return spacePerData / 2 + executorIdFontSize / 2;
});

var graphBarFontSize = 16;

var groupForEachTask = group
.selectAll("g")
.data(function(d) {
  return d.Tasks;
})
.enter()
.append("g")
.attr("width", function(d) {
  return xScale(d.end - d.start - margin);
})
.attr("height", barGraphWidth)
.attr("transform", function(d,i) { return "translate(" + (IDSpace + xScale(d.start)) + ", " + (spacePerData - barGraphWidth) / 2 + ")"; })
.on("mouseover", function(){
  d3
  .select(this)
  .select("rect")
  .style("fill", "black");

  d3
  .select(this)
  .select('#information')
  .style("visibility", "visible");

})
.on("mouseout", function(){
  d3
  .select(this)
  .select("rect")
  .style("fill", "blue");

  d3
  .select(this)
  .select('#information')
  .style("visibility", "hidden");

});

groupForEachTask
.append("rect")
.attr("id", "bar")
.style("fill", "blue")
.attr("x", 0)
.attr("y", 0)
.attr("width", function(d) {
  return xScale(d.end - d.start - margin);
})
.attr("height", barGraphWidth);

groupForEachTask
.append("text")
.text(function(d) { return "TID: " + d.TaskID; } )
.attr("font-size", graphBarFontSize + "px")
.attr("fill", "white")
.attr("x", function(d) {
  return 5;
})
.attr("y", function(d) {
  return spacePerData / 2 + graphBarFontSize / 2;
});

var groupForEachTaskInformation = groupForEachTask
.append("g")
.attr("id", "information")
.style("visibility", "hidden")
.attr("transform", "translate(20,-50)");

groupForEachTaskInformation
.append("rect")
.style("fill", "white")
.attr("width", 50)
.attr("height", 40)
.attr("x", 0)
.attr("y", 0);

groupForEachTaskInformation
.append("text")
.text("test text")
.attr("font-size", graphBarFontSize + "px")
.attr("fill", "black")
.attr("x", 5)
.attr("y", graphBarFontSize + 5);


var axisHeight = 20;
var axisWidth = graphSvgWidth;
var axisTop = graphDivTop + graphDivHeight;
var axisLeft = graphDivLeft;

var axisSvg = d3
.select("body")
.append("svg")
.attr("width", axisWidth)
.attr("height", axisHeight)
.style("position", "absolute")
.style("top", axisTop  + "px")
.style("left",  axisLeft + "px");

axisSvg.append("g")
.attr("class", "axis")
.attr("transform", "translate(" + IDSpace + ",0)")
.call(xAxis)
.selectAll("text")
.attr("transform", "rotate(45)");


    </script>


  </body>
</html>
