<!DOCTYPE html>
<html>
  <head>
    <title>WEB UI Test Page</title>
    <link rel="stylesheet" href="style.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  </head>

  <body>
    <h1>Spark Data Web Analyzer</h1>
    <h2>Executer Timeline</h2>
    <script type="text/javascript">
d3.csv("eventlog.txt", function(error, taskInfoArray) {
  var taskInfoArrayGroupedByExecutorID = d3
    .nest()
    .key(function(taskInfo) { return Number(taskInfo.executorID) })
    .entries(taskInfoArray);

  <!--d3.select("body").append("div").text(JSON.stringify(taskInfoArrayGroupedByExecutorID));-->

  var barGraphWidth = 24;
  var spacePerData = 32;
  var barStrokeWidth = 1;
  var IDSpace = 100;
  var graphRightPadding = 100;

  var graphSvgHeight = taskInfoArrayGroupedByExecutorID.length * spacePerData;
  var graphSvgWidth = 1600;
  var graphDivHeight = 200;
  var graphDivWidth = graphSvgWidth;

  var graphDivTop = 120;
  var graphDivLeft = 0;

  var graphDiv = d3
    .select("body")
    .append("div")
    .style("height", graphDivHeight + "px")
    .style("width", graphDivWidth + "px")
    .style("overflow-x", "hidden")
    .style("overflow-y", "scroll")
    .style("position", "absolute")
    .style("top", graphDivTop + "px")
    .style("left", graphDivLeft + "px");

  var graphSvg = graphDiv
    .append("svg")
    .attr("width", graphSvgWidth)
    .attr("height", graphSvgHeight);

  var minLength = d3.min(taskInfoArrayGroupedByExecutorID, function(taskInfoGroupedByExecutorID) { 
    return d3.min(taskInfoGroupedByExecutorID.values, function(taskInfo) {
      return Number(taskInfo.taskStartTime);
    });
  });

  var maxLength = d3.max(taskInfoArrayGroupedByExecutorID, function(taskInfoGroupedByExecutorID) { 
    return d3.max(taskInfoGroupedByExecutorID.values, function(taskInfo) {
      return Number(taskInfo.taskFinishTime);
    });
  });

  var xScale = d3.scale.linear().domain([minLength, maxLength]).range([0, graphSvgWidth - graphRightPadding - IDSpace]);

  var xAxis = d3.svg.axis().scale(xScale).orient("bottom");

  var taskInfoGroupedByExecutorIDGTag = graphSvg
    .selectAll("g")
    .data(taskInfoArrayGroupedByExecutorID)
    .enter()
    .append("g")
    .attr("transform", function(taskInfoGroupedByExecutorID,i) { return "translate(0," + i * spacePerData + ")"; });

  taskInfoGroupedByExecutorIDGTag
    .append("rect")
    .style("fill", function(taskInfoGroupedByExecutorID,i) {
      return i % 2 == 0 ? "rgb(200,200,200)" : "rgb(225,225,225)";
    })
  .attr("x", 0)
    .attr("y", 0)
    .attr("width", function() {
      return IDSpace + xScale(maxLength) + graphRightPadding;
    })
  .attr("height", spacePerData);

  var xAxisTick = d3.svg.axis().scale(xScale).orient("bottom").tickSize(graphSvgHeight).tickSubdivide(true);

  graphSvg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + IDSpace + ",0)")
    .call(xAxisTick);

  var IDFontSize = 16;

  taskInfoGroupedByExecutorIDGTag
    .append("text")
    .text(function(taskInfoGroupedByExecutorID) {
      return "ExecutorID: " + taskInfoGroupedByExecutorID.key;
    })
  .attr("font-size", IDFontSize + "px")
    .attr("fill", "black")
    .attr("x", 0)
    .attr("y", function() {
      return spacePerData / 2 + IDFontSize / 2;
    });

  var graphBarFontSize = 16;

  var taskInfoGTag = taskInfoGroupedByExecutorIDGTag
    .selectAll("g")
    .data(function(taskInfoGroupedByExecutorID) {
      return taskInfoGroupedByExecutorID.values;
    })
  .enter()
    .append("g")
    .attr("width", function(taskInfo) {
      return xScale(Number(taskInfo.taskFinishTime)) - xScale(Number(taskInfo.taskStartTime));
    })
  .attr("height", barGraphWidth)
    .attr("transform", function(taskInfo) { 
      return "translate(" + (IDSpace + xScale(Number(taskInfo.taskStartTime))) + ", " + (spacePerData - barGraphWidth) / 2 + ")";
    })
  .on("mouseover", function(){
    d3
      .select(this)
      .select("rect")
      .style("fill", "black");

    d3
      .select(this)
      .select('#information')
      .style("visibility", "visible");

  })
  .on("mouseout", function(){
    d3
      .select(this)
      .select("rect")
      .style("fill", "blue");

    d3
      .select(this)
      .select('#information')
      .style("visibility", "hidden");

  });

  taskInfoGTag
    .append("rect")
    .attr("id", "bar")
    .style("fill", "blue")
    .style("stroke", "white")
    .style("stroke-width", barStrokeWidth)
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", function(taskInfo) {
      return xScale(Number(taskInfo.taskFinishTime)) - xScale(Number(taskInfo.taskStartTime));
    })
  .attr("height", barGraphWidth);

  taskInfoGTag
    .append("text")
    .text(function(taskInfo) { return "TID: " + Number(taskInfo.taskID); } )
    .attr("font-size", graphBarFontSize + "px")
    .attr("fill", "white")
    .attr("x", function() {
      return 5;
    })
  .attr("y", function() {
    return spacePerData / 2 + graphBarFontSize / 2 - 2;
  });

  var taskInfoGTagInformation = taskInfoGTag
    .append("g")
    .attr("id", "information")
    .style("visibility", "hidden")
    .attr("transform", "translate(20,-50)");

  taskInfoGTagInformation
    .append("rect")
    .style("fill", "white")
    .attr("width", 50)
    .attr("height", 40)
    .attr("x", 0)
    .attr("y", 0);

  taskInfoGTagInformation
    .append("text")
    .text("test text")
    .attr("font-size", graphBarFontSize + "px")
    .attr("fill", "black")
    .attr("x", 5)
    .attr("y", graphBarFontSize + 5);


  var axisHeight = 20;
  var axisWidth = graphSvgWidth;
  var axisTop = graphDivTop + graphDivHeight;
  var axisLeft = graphDivLeft;

  var axisSvg = d3
    .select("body")
    .append("svg")
    .attr("width", axisWidth)
    .attr("height", axisHeight)
    .style("position", "absolute")
    .style("top", axisTop  + "px")
    .style("left",  axisLeft + "px");

  axisSvg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + IDSpace + ",0)")
    .call(xAxis)
    .selectAll("text")
    .attr("transform", "rotate(0)");

});

    </script>


  </body>
</html>
